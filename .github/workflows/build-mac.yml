name: Build macOS
permissions:
  contents: read

on:
  push:
    branches: [ dev, main, master ]
  pull_request:
    branches: [ dev, main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Build ProxyBridge (Universal Binary)
      run: |
        cd MacOS/ProxyBridge
        xcodebuild \
          -project ProxyBridge.xcodeproj \
          -scheme ProxyBridge \
          -configuration Release \
          -derivedDataPath build/DerivedData \
          ARCHS="arm64 x86_64" \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          clean build
    
    - name: Verify Universal Binary
      run: |
        cd MacOS/ProxyBridge
        lipo -info build/DerivedData/Build/Products/Release/ProxyBridge.app/Contents/MacOS/ProxyBridge
    
    - name: Upload App artifact
      uses: actions/upload-artifact@v4
      with:
        name: ProxyBridge-macOS-Universal
        path: MacOS/ProxyBridge/build/DerivedData/Build/Products/Release/ProxyBridge.app
        retention-days: 30
