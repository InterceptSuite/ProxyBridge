name: Build macOS
permissions:
  contents: read

on:
  push:
    branches: [ dev, main, master ]
  pull_request:
    branches: [ dev, main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Import Code Signing Certificates
      env:
        DEVELOPER_ID_APP_CERT: ${{ secrets.DEVELOPER_ID_APP_CERT }}
        DEVELOPER_ID_APP_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_APP_CERT_PASSWORD }}
        DEVELOPER_ID_INSTALLER_CERT: ${{ secrets.DEVELOPER_ID_INSTALLER_CERT }}
        DEVELOPER_ID_INSTALLER_CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_INSTALLER_CERT_PASSWORD }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        security list-keychains -d user -s login.keychain
        
        security create-keychain -p actions build.keychain
        security list-keychains -d user -s build.keychain $(security list-keychains -d user | sed s/\"//g)
        security set-keychain-settings build.keychain
        security unlock-keychain -p actions build.keychain
        
        echo "$DEVELOPER_ID_APP_CERT" | base64 --decode > app_cert.p12
        security import app_cert.p12 -k build.keychain -P "$DEVELOPER_ID_APP_CERT_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/productsign
        
        echo "$DEVELOPER_ID_INSTALLER_CERT" | base64 --decode > installer_cert.p12
        security import installer_cert.p12 -k build.keychain -P "$DEVELOPER_ID_INSTALLER_CERT_PASSWORD" -A -T /usr/bin/codesign -T /usr/bin/productsign
        
        security set-key-partition-list -S apple-tool:,apple: -s -k actions -D "$TEAM_ID" -t private build.keychain
        
        rm app_cert.p12 installer_cert.p12
    
    - name: Setup Notarization Profile
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        xcrun notarytool store-credentials "notarytool-profile" \
          --apple-id "$APPLE_ID" \
          --team-id "$TEAM_ID" \
          --password "$APPLE_PASSWORD"
    
    - name: Build Universal Binary
      run: |
        cd MacOS/ProxyBridge
        xcodebuild \
          -project ProxyBridge.xcodeproj \
          -scheme ProxyBridge \
          -configuration Release \
          -derivedDataPath build/DerivedData \
          ARCHS="arm64 x86_64" \
          ONLY_ACTIVE_ARCH=NO \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          clean build
    
    - name: Sign App and Extension
      env:
        DEVELOPER_ID_IDENTITY: ${{ secrets.DEVELOPER_ID_IDENTITY }}
      run: |
        cd MacOS/ProxyBridge
        
        codesign --force --options runtime --timestamp \
          --sign "$DEVELOPER_ID_IDENTITY" \
          --entitlements extension/extensionRelease.entitlements \
          build/DerivedData/Build/Products/Release/ProxyBridge.app/Contents/Library/SystemExtensions/com.interceptsuite.ProxyBridge.extension.systemextension
        
        codesign --force --options runtime --timestamp \
          --sign "$DEVELOPER_ID_IDENTITY" \
          --entitlements ProxyBridge/ProxyBridgeRelease.entitlements \
          build/DerivedData/Build/Products/Release/ProxyBridge.app
        
        codesign --verify --deep --strict build/DerivedData/Build/Products/Release/ProxyBridge.app
    
    - name: Create and Sign PKG
      env:
        DEVELOPER_ID_INSTALLER_IDENTITY: ${{ secrets.DEVELOPER_ID_INSTALLER_IDENTITY }}
      run: |
        cd MacOS/ProxyBridge
        mkdir -p output
        
        pkgbuild \
          --root build/DerivedData/Build/Products/Release \
          --identifier com.interceptsuite.ProxyBridge \
          --version 3.0.0 \
          --install-location /Applications \
          build/temp.pkg
        
        productsign \
          --keychain build.keychain \
          --sign "$DEVELOPER_ID_INSTALLER_IDENTITY" \
          build/temp.pkg \
          output/ProxyBridge-Installer.pkg
        
        pkgutil --check-signature output/ProxyBridge-Installer.pkg
    
    - name: Notarize PKG
      run: |
        cd MacOS/ProxyBridge
        
        xcrun notarytool submit output/ProxyBridge-Installer.pkg \
          --keychain-profile "notarytool-profile" \
          --wait
        
        xcrun stapler staple output/ProxyBridge-Installer.pkg
        xcrun stapler validate output/ProxyBridge-Installer.pkg
    
    - name: Upload PKG
      uses: actions/upload-artifact@v4
      with:
        name: ProxyBridge-macOS-Signed
        path: MacOS/ProxyBridge/output/ProxyBridge-Installer.pkg
        retention-days: 30
    
    - name: Cleanup
      if: always()
      run: |
        security delete-keychain build.keychain || true
        security default-keychain -s login.keychain || true
